<!doctype html>
<html lang="ko" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">배달비 노노 프로젝트을 진행하며 | Jake Son Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://jbl428.github.io/배달비-노노-프로젝트을-진행하며"><meta data-rh="true" name="docusaurus_locale" content="ko"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="ko"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="배달비 노노 프로젝트을 진행하며 | Jake Son Blog"><meta data-rh="true" name="description" content="사이드 프로젝트로 진행하고 있는 배달비 노노 백엔드 서버에 대한 소개와 기술적인 고민에 대한 내용을 담았다."><meta data-rh="true" property="og:description" content="사이드 프로젝트로 진행하고 있는 배달비 노노 백엔드 서버에 대한 소개와 기술적인 고민에 대한 내용을 담았다."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-11-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/jbl428"><meta data-rh="true" property="article:tag" content="hexagonal,fp-ts,prisma"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jbl428.github.io/배달비-노노-프로젝트을-진행하며"><link data-rh="true" rel="alternate" href="https://jbl428.github.io/배달비-노노-프로젝트을-진행하며" hreflang="ko"><link data-rh="true" rel="alternate" href="https://jbl428.github.io/배달비-노노-프로젝트을-진행하며" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://WGKI0UBE1C-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Jake Son Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Jake Son Blog Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Jake Son Blog" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.f0689d14.css">
<link rel="preload" href="/assets/js/runtime~main.848d0c4c.js" as="script">
<link rel="preload" href="/assets/js/main.44da30be.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="본문으로 건너뛰기"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">본문으로 건너뛰기</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/gopher.png" alt="Jake Son Blog" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/gopher.png" alt="Jake Son Blog" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Jake Son Blog</b></a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/jbl428" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="어두운 모드와 밝은 모드 전환하기 (현재 밝은 모드)" aria-label="어두운 모드와 밝은 모드 전환하기 (현재 밝은 모드)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="검색"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">검색</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">최근 게시물</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Open-Telemetry와-Effect-TS로-Nest.js-애플리케이션-모니터링하기">Open Telemetry와 Effect-TS로 Nest.js 애플리케이션 모니터링하기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Effect-TS로-테스트-가능하고-효율적인-코드-작성하기">Effect-TS로 테스트 가능하고 효율적인 코드 작성하기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/fly.io-에서-제공하는-redis-사용하기">fly.io 에서 제공하는 redis 사용하기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Typescript로-확률-Monad-구현하기-2">Typescript로 확률 Monad 구현하기 - 2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/Typescript로-확률-Monad-구현하기-1">Typescript로 확률 Monad 구현하기 - 1</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">배달비 노노 프로젝트을 진행하며</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-11-07T00:00:00.000Z" itemprop="datePublished">2022년 11월 7일</time> · <!-- -->약 22분</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/jbl428" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/22140938?v=4" alt="Jake Son"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jbl428" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jake Son</span></a></div><small class="avatar__subtitle" itemprop="description">Backend Developer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>사이드 프로젝트로 진행하고 있는 <a href="https://github.com/bae-no/bae-no-server" target="_blank" rel="noopener noreferrer">배달비 노노 백엔드 서버</a>에 대한 소개와 기술적인 고민에 대한 내용을 담았다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="프로젝트-소개">프로젝트 소개<a href="#프로젝트-소개" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h2><p>배달비 노노 프로젝트는 이름 그대로 주문 음식의 배달비를 줄일 수 있는 기회를 제공해준다.<br>
<!-- -->근처에 있는 사람들끼리 모여 같이 주문한 후 배달비를 나눠서 지불하는 방식이다.</p><p>애플리케이션 형태로 제공하며 사용자는 본인 주변에 있는 공유딜을 찾아 참여한 후 채팅을 통해 서로 소통하여 주문 및 정산을 진행한다.<br>
<!-- -->간단히 말해, 짧은 주기를 가지는 채팅방 어플리케이션이라고 볼 수 있다.</p><p><img loading="lazy" alt="share-deal" src="/assets/images/share-deal-79a91f20e14a04d1455712954ac823ad.jpg" width="282" height="610" class="img_ev3q">
<img loading="lazy" alt="chat-room" src="/assets/images/chat-room-dc5f365b8b60362bdc5ded2e3d5bd2fa.jpg" width="282" height="610" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="개발-스택">개발 스택<a href="#개발-스택" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h2><p>백엔드 서버의 개발 스택은 다음과 같이 이루어져 있다.</p><ul><li>Nest.JS</li><li>GraphQL</li><li>MongoDB</li><li>Prisma</li></ul><p>Nest.js에서 주로 REST로만 개발을 진행해봐서 이번에 GraphQL을 사용해보고 싶었다.<br>
<!-- -->MongoDB는 회사에서 검색엔진으로 사용하면서 처음 사용해보았는데 그 경험이 좋았고 채팅방 이력을 저장하기 좋은 구조라고 생각해 선택하였다.<br>
<!-- -->Prisma도 이번에 처음 사용해보았고 예전부터 사용해온 TypeORM, MikroORM과 비교해 어떤점이 좋을지 경험하고자 선택하였다.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="프로젝트-구조">프로젝트 구조<a href="#프로젝트-구조" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h2><p>업무에서 계속 사용해온 계층형 아키텍쳐대신 헥사고날 아키텍쳐라고 불리는 포트와 어댑터 패턴을 사용했다.<br>
<!-- -->전체적인 디렉토리 구조는 <a href="http://www.yes24.com/Product/Goods/105138479" target="_blank" rel="noopener noreferrer">만들면서 배우는 클린 아키텍처</a>를 참고해서 만들었다.<br>
<!-- -->파일명도 일반적인 Nest.js컨벤션 대신 JVM에서 많이 사용하는 패턴을 사용했다.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── SampleModule.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── adapter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── gql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── SampleMutationResolver.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── SampleQueryResolver.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── SampleSubscriptionResolver.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       │   └── CreateSampleInput.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       └── response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │           └── SampleResponse.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── persistence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ├── SampleOrmMapper.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ├── SampleQueryRepositoryAdapter.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           └── SampleRepositoryAdapter.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── SampleCommandUseCase.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   ├── SampleQueryUseCase.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │   └── dto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   │       └── CreateSampleCommand.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       ├── SampleQueryRepositoryPort.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       └── SampleRepositoryPort.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── SampleCommandService.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── SampleQueryService.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── domain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── Sample.ts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>src 디렉토리 아래에 모듈별로 디렉토리를 만들고 그 안에 위와 같은 구조로 파일을 만들었다.<br>
<!-- -->모듈 안에는 크게 domain, application, adapter로 나누었고 각각 다음과 관련된 로직이 들어있다.</p><ul><li>domain: 도메인 모델과 비즈니스 로직</li><li>application: 도메인 모델을 사용하는 비즈니스 로직</li><li>adapter: GraphQL, Notification, DB등 인프라와 관련된 로직</li></ul><p>시간이 지나면 언제든지 변경될 수 있는 요소는 adapter에 모아두고, 도메인과 비즈니스 로직은 application과 domain에 위치한다.<br>
<!-- -->application에는 외부에서 사용할 <code>inbound port</code>인터페이스와 Service에서 사용하는 <code>outbound port</code>인터페이스가 있다.<br>
<!-- -->adatper는 <code>outbound port</code>를 구현하고 <code>inbound port</code>를 사용해 GraphQL과 같은 api요청과 응답로직을 구현한다.<br>
<!-- -->domain은 모두 순수한 클래스만 가지고 있으며 핵심적인 비즈니스 로직만을 가지고 있다.</p><p><img loading="lazy" alt="dir-structure" src="/assets/images/dir-structure-c767b824eaf33bad1597d135a29399ae.jpg" width="1998" height="2001" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fp-ts">fp-ts<a href="#fp-ts" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h2><p><a href="https://gcanti.github.io/fp-ts/" target="_blank" rel="noopener noreferrer">fp-ts</a>는 대수적 자료형을 제공하는 라이브러리로 <code>Option</code>, <code>Task</code>, <code>Either</code> 등의 유용한 타입을 제공한다.<br>
<!-- -->예전부터 여러 프로그래밍 패러다임을 같이 사용해보고 싶었고 어떤 장단점이 있을지 궁금했다.</p><p>이전 <code>santa-close</code>프로젝트에서 <code>spring + kotlin arrow</code>를 사용했지만 제대로 활용하지 못했다.<br>
<!-- -->이번에는 대부분의 메소드 내부구현은 <code>fp-ts</code>를 활용해 순수 메소드로 만들고, 실제 응답값을 반환해야 하는 resolver에서만 사이드 이펙트가 발생하도록 만들었다.<br>
<!-- -->대부분의 메소드가 비동기 로직을 담고있고 에러가 발생할 수 있기에 <code>TaskEither</code>를 주로 사용했다.</p><p>각 패러다임을 활용하는 부분은 다음과 같다.</p><ul><li>OOP: 의존성 주입, 상태와 행위의 결합</li><li>FP: 에러처리, 병렬처리, 부작용 제거</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="느낀점-및-고민">느낀점 및 고민<a href="#느낀점-및-고민" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h2><p>프로젝트를 진행하면서 느낀점과 고민을 정리해보았다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fp-ts-의존성">fp-ts 의존성<a href="#fp-ts-의존성" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h3><p><code>fp-ts</code>는 외부 라이브러리이기에 어느 영역까지 사용을 허용할지 고민이 많았다.<br>
<!-- -->예를들어 도메인 클래스의 유효성 검증 메소드를 생각해보자.<br>
<!-- -->검증에 실패하면 일반적인 경우에는 다음과 같은 도메인 에러를 던지는 코드를 작성할 것이다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PhoneVerification</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...생략</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">verify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> now </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">code </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MismatchedCodeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isExpired</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ExpiredCodeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위 메소드를 사용하는 곳은 서비스 영역인데 순수메소드 형태를 유지하기 위해 <code>tryCatch</code>를 사용해 <code>Either</code>로 만들어야 하는 불편함이 존재한다.<br>
<!-- -->또한 메소드의 구현부를 읽어야만 해당 메소드가 어떤 에러를 던지는지 파악할 수 있다는 단점이 있다.<br>
<!-- -->이는 <strong>메소드의 시그니쳐만 읽어도 어떤 에러가 발생하는지 파악</strong>할 수 있는 <code>Either</code>의 장점을 포기해야 하는 상황이었다.</p><p>하지만 도메인 클래스 내부에서 <code>Either</code>를 반환하게 만들면 <code>fp-ts</code>라는 외부 라이브러리에 대한 의존성이 생기므로 가장 순수해야 할 영역이 오염된다.<br>
<!-- -->물론 <code>Either</code>와 같은 대수적 자료형은 직접 클래스 형태로 구현할 수 있지만 라이브러리에서 제공하는 여러 유틸리티 함수와 복잡한 타입추론까지 직접 구현해야 한다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 외부 의존성</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Either</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> left</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> right </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fp-ts/Either&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PhoneVerification</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...생략</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">verify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    code</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Either</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">ExpiredCodeException </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MismatchedCodeException</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">code </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">left</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MismatchedCodeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isExpired</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">left</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ExpiredCodeException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">right</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">undefined</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>여러 고민끝에 다음과 같은 결론을 내렸다.</p><p><code>Haskell</code>과 같은 순수 함수형 언어에서는 <code>Either</code>와 같은 대수적 자료형을 기본제공하기에 도메인 내부에서 사용하는데 문제가 없다.<br>
<!-- -->그래서 <code>fp-ts</code>의 자료형들을 <strong>node.js의 확장된 내장타입</strong>으로 생각하고 사용하기로 했다.<br>
<!-- -->물론 외부 라이브러리이기에 미래에 언제든지 교체될 수 있는 가능성이 있지만, Node의 <strong>String, Number, Boolean과 같은 교체되기 힘든 타입과 같은 영역</strong>을 다루기에 사용해도 괜찮다는 생각이 들었다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="모니터링과-로깅">모니터링과 로깅<a href="#모니터링과-로깅" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h3><p><code>fp-ts</code>를 사용하는 경우 모니터링과 로깅에 신경써야 하는 부분이 있다.<br>
<!-- -->보통 데이터베이스 조회와 같은 비동기 로직은 사이드 이팩트를 발생하므로 <code>TaskEither</code>를 사용하게된다.<br>
<code>TaskEither</code>는 promise를 사용하는 로직에 대한 추상화로 아직 어떠한 값을 가지고 있지 않는다.</p><p>보통 <code>TaskEither</code>를 반환하는 함수들을 합성해 최종적으로 하나의 함수를 만들며 이 함수를 실행할 때 비동기 로직이 실행된다.<br>
<!-- -->따라서 <code>TaskEither</code>를 반환하는 메소드의 실행시간을 측정하면 <strong>함수의 합성에 걸리는 시간만 포함하지 실제 비동기 로직에 대한 시간은 포함하지 않는다</strong>.</p><p>예를들어 datadog을 모니터링에 사용하는 경우 아래 코드처럼 span을 생성해 실행시간을 측정해보면 데이터베이스 상태와 관계없이 매우 짧은 일정한 시간을 가진다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> tracer </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dd-trace&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ChatQueryRepositoryAdapter</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  override </span><span class="token function" style="color:#d73a49">unreadCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shareDealId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaskEither</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">DBError</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ChatQueryRepositoryAdapter.unreadCount&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">tryCatchDB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prisma</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            where</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              shareDealId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              userId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">is</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> unread</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>또한 에러가 발생할 때 해당 에러객체에 대한 로그를 출력할 때 스택트레이스가 제대로 나오지 않는 문제가 있다.<br>
<!-- -->에러 인스턴스가 생성된 시점의 스택은 나오지만 생성 전까지 호출한 함수의 스택은 나오지 않는다.<br>
<!-- -->이는 <code>Error.captureStackTrace</code>을 사용하는 것으로 해결할 수 있다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">abstract</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">BaseException</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">captureStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">constructor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>위 클래스를 상속받아 도메인 에러클래스를 만들어 사용하면 된다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="의존성-주입">의존성 주입<a href="#의존성-주입" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h3><p>Nest.js를 사용하면서 얻을 수 있는 가장 큰 혜택은 의존성 주입이라고 생각한다.<br>
<code>@Injectable</code> 데코레이터를 사용해 원하는 클래스를 주입가능한 클래스로 만들 수 있으며 동시에 생성자에 선언한 항목을 런타임에 주입받을 수 있다.<br>
<!-- -->포트와 어댑터 패턴을 적용한 환경이라면 보통 어댑터는 포트 인터페이스를 구현하며 또 다른 포트 인터페이스를 주입받아 사용한다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Injectable </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@nestjs/common&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Injectable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShareDealCommandService</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">ShareDealCommandUseCase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 포트 인터페이스 구현</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> shareDealRepositoryPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ShareDealRepositoryPort </span><span class="token comment" style="color:#999988;font-style:italic">// 포트 인터페이스 주입</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JVM이라면 포트를 interface로 정의하고 어댑터가 해당 interface를 구현하는 것이 일반적이다.<br>
<!-- -->TypeScript에서는 동일하게 interface를 지원하지만 Nest.js의 provider로 사용할 수 없는 문제가 있다.<br>
<!-- -->TypeScript의 interface는 컴파일 타임에만 사용되고 트랜스파일 단계에서 무시되기 때문에 Nest.js가 해당 interface를 인식하지 못한다.</p><p>이를 해결하기 위해 <code>@Inject</code> 데코레이터를 사용하거나 interface대신 abstract class를 사용하는 방안이 있다.<br>
<!-- -->개인적으로 <code>@Inject</code> 데코레이터를 사용하는 것을 선호하지 않는데 다음과 같은 이유 때문이다.</p><ul><li><code>@Inject</code> 데코레이터를 사용하는 클래스는 Nest.js에 의존성이 생긴다.</li><li>데코레이터에 지정하는 token과 매칭되는 interface를 잘못 지정해도 컴파일 타임에는 에러가 발생하지 않는다.</li><li>매번 생성자 파라미터에 데코레이터 + 인터페이스를 선언해야 하는 번거로움이 있다.</li></ul><p>특히 두 번째 이유는 <strong>코드를 잘못 작성하고 있다는 피드백을 런타임까지 가야 받을 수 있는 점</strong>은 치명적이라고 생각하기에 abstract class를 사용하였다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Injectable </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@nestjs/common&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Injectable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShareDealCommandService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// token과 매칭되는 interface를 잘못 지정해도 에러가 발생하지 않는다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Inject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CHAT_REPOSITORY_PORT_TOKEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> shareDealRepositoryPort</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ShareDealRepositoryPort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nestjs-의존성">Nest.js 의존성<a href="#nestjs-의존성" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h3><p>프로젝트를 진행하면서 각 클래스가 Nest.js와의 의존성도 최대한 줄이려고 노력하였다.<br>
<!-- -->즉 비스니스 로직을 포함하는 클래스는 최대한 순수하게 가져갈 수 있도록 하였다.<br>
<!-- -->예를들면 환경변수를 사용하는 클래스가 있다면 보통은 Nest.js의 <code>ConfigService</code>를 주입받아 사용한다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Injectable </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@nestjs/common&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> ConfigService </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;@nestjs/config&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Injectable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShareDealCommandService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> configService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ConfigService</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>이는 위 클래스의 유닛 테스트에서도 <code>ConfigService</code>를 직접 만들어 주입해야 함을 의미한다.<br>
<!-- -->만약 미래에 Nest.js 대신 다른 프레임워크를 적용하려고 할 때 수정해야 하는 항목이 많아지게 된다.</p><p>이를 위해 <code>ConfigService</code>를 추상화한 <code>ConfigServicePort</code>를 만드는 방법이 있지만 이번에는 원하는 환경변수 값을 직접 주입하는 방법을 사용하였다.<br>
<!-- -->Nest.js에서는 의존성 주입에 사용하는 provider를 만들기 위한 여러가지 방법을 제공하는데 그 중 <code>useFactory</code>를 사용하였다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">JwtStrategy</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 원하는 환경변수를 직접 선언한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> jwtSecret</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Module</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  providers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      provide</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> JwtStrategy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      inject</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ConfigService</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function-variable function" style="color:#d73a49">useFactory</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configService</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> ConfigService</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 모듈 선언부에서 직접 configService를 활용해 원하는 환경변수를 주입한다.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">JwtStrategy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getOrThrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;JWT_SECRET&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exports</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">PushMessagePort</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PushMessageModule</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>모듈 선언 파일에서는 Nest.js의 의존성을 가지는게 전혀 문제가 되지 않으므로 이곳에서 configService를 사용하였다.</p><p>추가로 유닛 테스트에서도 가능하면 <code>@nestjs/testing</code> 패키지를 사용하지 않고 직접 의존성을 주입하였다.</p><div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">describe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ChatQueryService&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// stub과 mock을 활용해 의존성 생성</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shareDealQueryRepositoryPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">mock</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ShareDealQueryRepositoryPort</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> chatQueryRepositoryPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">mock</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">ChatQueryRepositoryPort</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> userQueryRepositoryPort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#d73a49">mock</span><span class="token generic-function generic class-name operator" style="color:#393A34">&lt;</span><span class="token generic-function generic class-name">UserQueryRepositoryPort</span><span class="token generic-function generic class-name operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> eventEmitter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">StubEventEmitter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 직접 의존성 주입</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> shareDealCommandService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ChatQueryService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shareDealQueryRepositoryPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chatQueryRepositoryPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userQueryRepositoryPort</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventEmitter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>더 극단적으로 의존성을 제거하려면 <code>@Injectable</code> 데코레이터조차 사용하지 않고 모듈 선언부에서 주입해주는 방법도 있다.<br>
<!-- -->하지만 이는 의존성이 하나 추가 될 때마다 모듈 선언부도 같이 수정해야 하는 번거로움이 있으며 앞서 이야기한 Nest.js의 장점을 제대로 활용하지 못한다고 생각한다.<br>
<!-- -->그래서 해당 데코레이터의 사용만 허용하였으며 추후에 다른 프레임워크를 쓴다고 해도 데코레이터명이나 import경로만 수정하면 되기에 변경의 어려움은 없을거라고 생각한다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prisma">Prisma<a href="#prisma" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h3><p>Prisma를 사용하면서 좋았던 점은 ORM을 위한 엔티티 클래스를 따로 만들지 않아도 된다는 것이었다.<br>
<!-- -->TypeORM과 같은 라이브러리를 사용했다면 도메인 클래스와 더불어 엔티티 클래스도 만들어야 하지만 Prisma는 스키마 파일만 작성해주면 된다.</p><p>또한 mongoDB와 함께 사용하는 경우 스키마 파일에서 DDD에서 이야기하는 Aggregate와 Value Object를 일부 추론할 수 있는점도 장점이라고 생각한다.<br>
<!-- -->RDB를 사용한다면 도메인 클래스의 구조와 RDBMS에 저장되는 구조가 다르지만 NoSQL을 사용한다면 둘 간의 차이를 줄일 수 있다.</p><div class="language-prisma codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-prisma codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">model ShareDeal { // Aggregate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id           String          @id @default(auto()) @map(&quot;_id&quot;) @db.ObjectId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  createdAt    DateTime        @unique @default(now())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  updatedAt    DateTime        @updatedAt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  title        String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zone         ShareZone       // value object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  participants ParticipantInfo // value object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ParticipantInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ids       String[] @db.ObjectId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  max       Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  current   Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  remaining Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="클립보드에 코드 복사" title="복사" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Prisma를 사용하는 경우 GraphQL과의 연동이 편리하다는 장점이 있지만 이번 프로젝트에는 활용하지 못했다.<br>
<!-- -->두 라이브러리간의 연동은 표현 영역과 인프라 영역간의 강한 결합을 의미하며 다른 의존성으로 교체하는 것을 어렵게 만들기 때문이다.</p><p>또한 Primsa에는 아직 geometry관련 기능이 존재하지 않는 아쉬움이 있다.<br>
<!-- -->이번 프로젝트에서 사용자 위치 기준으로 가까운 공유딜을 정렬하는 요구사항이 있는데 이를 위해 raw query를 사용해야 했다.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="도메인-이벤트">도메인 이벤트<a href="#도메인-이벤트" class="hash-link" aria-label="제목으로 바로 가기" title="제목으로 바로 가기">​</a></h3><p>방장이 공유딜을 시작하는 경우 다음과 같은 로직이 수행되야 한다.</p><ul><li>공유딜의 상태를 <code>START</code>로 변경한다.</li><li>채팅방에 시작 메시지를 추가한다.</li><li>채팅방을 구독(Graphql Subscription)하는 사용자들에게 메시지를 전송한다.</li><li>참여자들에게 알림(FCM)을 보낸다.</li></ul><p>위 로직을 하나의 서비스 메소드에서 처리할 수 있지만 공유딜의 상태를 변경하는 핵심로직과 알림같은 부가로직이 섞이게 된다.<br>
<!-- -->또한 공유딜과 채팅방은 서로 다른 Aggregate로 설계하여 하나의 트랜잭션으로 처리할 수 없었다.</p><p>이를 해결하기 위해 내부이벤트를 사용하였다.<br>
<!-- -->또한 채팅방에 시작 메시지를 추가하는 작업과 알림작업 또한 이벤트를 사용해 분리하였다.</p><p><img loading="lazy" alt="domain-event" src="/assets/images/domain-event-a66fb29ffb6294ef5afba727070bafd9.png" width="2264" height="1252" class="img_ev3q"></p><p>위와 같은 작업을 통해 각 영역간의 결합도를 낮출 수 있었지만 공유딜이 시작할 때 어떤일이 발생하는지 파악하기 어려워진다는 단점이 존재한다.<br>
<!-- -->추가로 공유딜의 상태만 변경되고 채팅방에 메시지가 추가되지 않는 상황에 대한 처리가 필요하다.<br>
<!-- -->이번 프로젝트에는 이와 같은 상황에 대한 처리를 하지 않았지만 실무였다면 반드시 고려해야 한다.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>태그:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/hexagonal">hexagonal</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/fp-ts">fp-ts</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/prisma">prisma</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/jbl428/jbl428.github.io/edit/main/blog/2022-11-07-bae-no-architecture/index.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>페이지 편집</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="블로그 게시물 탐색"><a class="pagination-nav__link pagination-nav__link--prev" href="/Typescript로-확률-Monad-구현하기-1"><div class="pagination-nav__sublabel">이전 게시물</div><div class="pagination-nav__label">Typescript로 확률 Monad 구현하기 - 1</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/MongoDB-Atlas-Search로-컬럼기반-정렬하기"><div class="pagination-nav__sublabel">다음 게시물</div><div class="pagination-nav__label">MongoDB Atlas Search로 컬럼기반 정렬하기</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#프로젝트-소개" class="table-of-contents__link toc-highlight">프로젝트 소개</a></li><li><a href="#개발-스택" class="table-of-contents__link toc-highlight">개발 스택</a></li><li><a href="#프로젝트-구조" class="table-of-contents__link toc-highlight">프로젝트 구조</a></li><li><a href="#fp-ts" class="table-of-contents__link toc-highlight">fp-ts</a></li><li><a href="#느낀점-및-고민" class="table-of-contents__link toc-highlight">느낀점 및 고민</a><ul><li><a href="#fp-ts-의존성" class="table-of-contents__link toc-highlight">fp-ts 의존성</a></li><li><a href="#모니터링과-로깅" class="table-of-contents__link toc-highlight">모니터링과 로깅</a></li><li><a href="#의존성-주입" class="table-of-contents__link toc-highlight">의존성 주입</a></li><li><a href="#nestjs-의존성" class="table-of-contents__link toc-highlight">Nest.js 의존성</a></li><li><a href="#prisma" class="table-of-contents__link toc-highlight">Prisma</a></li><li><a href="#도메인-이벤트" class="table-of-contents__link toc-highlight">도메인 이벤트</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Jake Son, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.848d0c4c.js"></script>
<script src="/assets/js/main.44da30be.js"></script>
</body>
</html>