---
title: "ts-morph 로 개발 컨벤션 검증 자동화하기"
authors: jake
tags: [ts-morph, static-analysis]
---

최근에 typescript 환경에서 개발 컨벤션을 확인하는 작업을 자동화하는 방법을 찾다가 `ts-morph` 를 도입하게 된 과정을 기술하려고 한다.

> 관련 코드는 아래 링크에서 확인할 수 있다.

- https://github.com/jbl428/study-note/tree/master/ts-morph

<!--truncate-->

## 컨벤션

아래와 같은 `TypeORM` 엔티티 파일이 있다고 가정한다.

```ts title="Profile.entity.ts"
import { Column, Entity, PrimaryGeneratedColumn } from "typeorm";

@Entity()
export class Profile {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  name: string;

  @Column()
  email: string;
}
```

```ts title="Post.entity.ts"
import {
  Column,
  Entity,
  Index,
  JoinColumn,
  ManyToOne,
  PrimaryGeneratedColumn,
} from "typeorm";
import { Profile } from "./Profile.entity";

@Entity()
// highlight-start
@Index("idx_post_1", ["profile"]) // profile_id 에 인덱스를 추가
@Index("idx_post_2", ["status"]) // status 필드에 인덱스를 추가
// highlight-end
export class Post {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  content: string;

  @Column()
  status: string;

  // highlight-start
  // profile 과 1:n 관계이지만 FK 를 설정하지 않음
  @ManyToOne(() => Profile, { createForeignKeyConstraints: false })
  // profile 연관관계 필드 추가
  @JoinColumn({ name: "profile_id", referencedColumnName: "id" })
  profile: Profile;
  // highlight-end
}
```

`Post` 엔티티는 `Profile` 과 1:N 관계이고 `profile_id` 필드가 있지만 외래키를 추가하지 않고 대신 class 상단에 `@Index` 데코레이터를 이용해 인덱스를 추가한다.
인덱스를 추가하지 않으면 join 성능이 떨어지기 때문에 개발자가 인덱스를 추가하지 않는 실수를 하지 않도록 검증과정을 자동화하려고 했다.

## Shell script 로 검증

처음에는 bash 스크립트를 활용해서 각 엔티티 파일을 읽은 후 정규식을 활용해 검증을 시도하려 했지만 다음과 같은 이유로 하지 않았다.

### OS

현재 개발팀 모두 mac 을 사용하기에 스크립트를 실행하는데 어려움이 없지만 추후에 윈도우를 사용하는 사람이 올 수도 있다.
스크립트를 CI 에서 실행하면 큰 문제는 없지만 OS 에 관계없이 누구나 로컬에서 편리하게 검증할 수 있도록 하고 싶었다.

### 유지보수

shell script 에 익숙하지 않은 개발자도 있어서 해당 스크립트를 유지보수 할 수 있는 사람이 적어진다.
개발환경과 같은 언어를 활용해 검증을 한다면 코드를 이해하고 개선할 수 있는 사람이 많아질것이다.

### 구현

검증을 위해서 파일 내용 중 `JoinColumn` 데코레이터로 선언한 필드명 (예제에서는 `profile`) 을 알아내야 하는데 코드 상황에 따라 그 위치가 달라질 수 있다.

- JoinColumn 라인 바로 아래에 컬럼명이 존재

```ts
  @ManyToOne(() => Profile, { createForeignKeyConstraints: false })
  @JoinColumn({ name: "profile_id", referencedColumnName: "id" })
  profile: Profile;
```

- JoinColumn 두 라인 아래에 컬럼명이 존재

```ts
  @JoinColumn({ name: "profile_id", referencedColumnName: "id" })
  @ManyToOne(() => Profile, { createForeignKeyConstraints: false })
  profile: Profile;
```

- JoinColumn 세 라인 아래에 컬럼명이 존재

```ts
  @ManyToOne(() => Profile, { createForeignKeyConstraints: false })
  @JoinColumn({
    name: "profile_id",
    referencedColumnName: "id"
  })
  profile: Profile;
```

- JoinColumn 과 같은 라인에 존재

```ts
  @ManyToOne(() => Profile, { createForeignKeyConstraints: false })
  @JoinColumn({ name: "profile_id", referencedColumnName: "id" }) profile: Profile;
```

`prettier` 를 사용하면 몇가지 상황은 배제할 수 있지만 컬럼명을 알아내기 위해 multiline 에 대한 정규식 표현을 사용해야 하는 불편함이 있다.
그리고 컬럼명을 가져온 후 `@Index` 에 선언된 컬렴명과 비교하는 로직을 shell script 로 구현하기도 복잡하다.

위와 같은 이유로 shell script 보다 개발환경과 같은 언어인 typescript 을 활용하고 싶었고 이전부터 눈여겨본 `ts-morph` 를 도입해보았다.

## ts-morph

[ts-morph](https://github.com/dsherret/ts-morph/tree/latest/packages/ts-morph) 는 난해한 `typescript ast` 를 사용하기 편리하게 만든 wrapper 라이브러리이다.
타입스크립트 코드를 프로그래밍 적으로 분석 및 수정할 수 있게한다.
사용법 자체도 간단해서 이번에 문서를 보고 처음 사용해보았는데 어렵지 않게 작업할 수 있었다.
